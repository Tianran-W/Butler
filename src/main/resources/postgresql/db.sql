-- 创建角色表（先创建，因为用户表需要引用它）
CREATE TABLE tb_role
(
    role_id     SERIAL PRIMARY KEY,
    role_name   VARCHAR(50) NOT NULL,
    permissions TEXT
);

-- 创建用户表
CREATE TABLE tb_user
(
    user_id    SERIAL PRIMARY KEY,
    username   VARCHAR(50)  NOT NULL UNIQUE,
    email      VARCHAR(100) NOT NULL UNIQUE,
    password   VARCHAR(255) NOT NULL,
    role_id    INTEGER REFERENCES tb_role (role_id),
    department VARCHAR(50)
);

-- 创建物资分类表
CREATE TABLE tb_material_category
(
    category_id   SERIAL PRIMARY KEY,
    category_name VARCHAR(50) NOT NULL
);
ALTER TABLE tb_material_category ADD CONSTRAINT unique_category_name UNIQUE (category_name);

-- 创建物资表
CREATE TABLE tb_material
(
    material_id   SERIAL PRIMARY KEY,
    material_name VARCHAR(100) NOT NULL,
    category_id   INTEGER REFERENCES tb_material_category (category_id),
    is_expensive  SMALLINT              DEFAULT 0 CHECK (is_expensive IN (0, 1)),
    sn_code       VARCHAR(50),
    quantity      INTEGER      NOT NULL DEFAULT 0,
    usage_limit   INTEGER,
    status        VARCHAR(20)  NOT NULL
);

-- 创建物资使用记录表
CREATE TABLE tb_material_usage_record
(
    record_id     SERIAL PRIMARY KEY,
    material_id   INTEGER REFERENCES tb_material (material_id),
    user_id       INTEGER REFERENCES tb_user (user_id),
    borrow_time   TIMESTAMP NOT NULL,
    return_time   TIMESTAMP,
    usage_project VARCHAR(100)
);

-- 创建审批表
CREATE TABLE tb_approval
(
    approval_id     SERIAL PRIMARY KEY,
    material_id     INTEGER REFERENCES tb_material (material_id),
    user_id         INTEGER REFERENCES tb_user (user_id),
    approval_reason TEXT        NOT NULL,
    approval_status VARCHAR(20) NOT NULL,
    approval_time   TIMESTAMP
);

-- 创建电池状态表
CREATE TABLE tb_battery_status
(
    status_id     SERIAL PRIMARY KEY,
    material_id   INTEGER REFERENCES tb_material (material_id),
    battery_level INTEGER CHECK (battery_level BETWEEN 0 AND 100),
    battery_health VARCHAR(20),
    record_time TIMESTAMP NOT NULL
);

-- 创建报销关联表
CREATE TABLE tb_reimbursement_relation
(
    relation_id      SERIAL PRIMARY KEY,
    material_id      INTEGER REFERENCES tb_material (material_id),
    reimbursement_id VARCHAR(50) NOT NULL
);

CREATE TABLE tb_image (
    image_id SERIAL PRIMARY KEY,
    record_type VARCHAR(20) NOT NULL CHECK (record_type IN ('borrow', 'return', 'scrap')),
    record_id INTEGER NOT NULL,
    image_path VARCHAR(255) NOT NULL,
    upload_time TIMESTAMP DEFAULT NOW()
);

-- 生成用户名单
INSERT INTO tb_user (username, email, password, department)
VALUES ('张三', 'zhangsan@example.com', '$2a$10$XPW39X5zW9jhRt3yIIwW3.OPhpEv2ijsQlqEnjKRBUP1vdlUsNWy.', '机械组'),
       ('李四', 'lisi@example.com', '$2a$10$XPW39X5zW9jhRt3yIIwW3.OPhpEv2ijsQlqEnjKRBUP1vdlUsNWy.', '视觉组'),
       ('王五', 'wangwu@example.com', '$2a$10$XPW39X5zW9jhRt3yIIwW3.OPhpEv2ijsQlqEnjKRBUP1vdlUsNWy.', '后勤组'),
       ('赵六', 'zhaoliu@example.com', '$2a$10$XPW39X5zW9jhRt3yIIwW3.OPhpEv2ijsQlqEnjKRBUP1vdlUsNWy.', '雷达组'),
       ('孙七', 'sunqi@example.com', '$2a$10$XPW39X5zW9jhRt3yIIwW3.OPhpEv2ijsQlqEnjKRBUP1vdlUsNWy.', '视觉组');

-- 插入分类：视觉、电控、硬件、机械
INSERT INTO tb_material_category (category_name)
VALUES ('视觉'),
       ('电控'),
       ('硬件'),
       ('机械');

-- 视觉类物资
INSERT INTO tb_material (material_name, category_id, is_expensive, sn_code, quantity, usage_limit, status)
VALUES
    ('工业相机MV-CA013-10GM', 1, 1, 'VIS-2025001', 3, 10, '已借出'),
    ('鱼眼镜头180°', 1, 0, 'VIS-2025002', 5, 7, '在库可借'),
    ('视觉光源LED条形', 1, 0, 'VIS-2025003', 8, 7, '在库可借'),
    ('图像采集卡PCIe', 1, 1, 'VIS-2025004', 2, 15, '在库可借'),
    ('标定板12*8', 1, 0, 'VIS-2025005', 4, 7, '在库可借');

-- 电控类物资
INSERT INTO tb_material (material_name, category_id, is_expensive, sn_code, quantity, usage_limit, status)
VALUES
    ('STM32F4开发板', 2, 0, 'ELE-2025006', 10, 7, '在库可借'),
    ('Arduino Mega2560', 2, 0, 'ELE-2025007', 15, 7, '在库可借'),
    ('步进电机驱动TB6600', 2, 0, 'ELE-2025008', 8, 10, '已借出'),
    ('舵机MG996R', 2, 0, 'ELE-2025009', 20, 7, '在库可借'),
    ('PLC西门子S7-1200', 2, 1, 'ELE-2025010', 2, 14, '已借出');

-- 硬件类物资
INSERT INTO tb_material (material_name, category_id, is_expensive, sn_code, quantity, usage_limit, status)
VALUES
    ('树莓派4B 8GB', 3, 1, 'HAR-2025011', 5, 14, '在库可借'),
    ('2.4G无线模块', 3, 0, 'HAR-2025012', 12, 7, '在库可借'),
    ('超声波传感器HC-SR04', 3, 0, 'HAR-2025013', 15, 7, '在库可借'),
    ('红外避障传感器', 3, 0, 'HAR-2025014', 10, 7, '在库可借'),
    ('激光测距仪VL53L0X', 3, 1, 'HAR-2025015', 3, 10, '已借出');

-- 机械类物资
INSERT INTO tb_material (material_name, category_id, is_expensive, sn_code, quantity, usage_limit, status)
VALUES
    ('铝合金型材4040', 4, 0, 'MEC-2025016', 20, 14, '在库可借'),
    ('舵机支架套件', 4, 0, 'MEC-2025017', 15, 7, '在库可借'),
    ('直流减速电机', 4, 0, 'MEC-2025018', 10, 10, '已借出'),
    ('联轴器弹性', 4, 0, 'MEC-2025019', 30, 7, '在库可借'),
    ('机械臂套件6DOF', 4, 1, 'MEC-2025020', 2, 15, '在库可借');

INSERT INTO tb_role (role_id, role_name, permissions) VALUES (1, 'admin', 'all');
INSERT INTO tb_role (role_id, role_name, permissions) VALUES (2, 'user', 'read,write');

UPDATE tb_user SET role_id = 1 WHERE username = '张三'; 
UPDATE tb_user SET role_id = 2 WHERE username IN ('李四', '王五', '赵六', '孙七')

CREATE TABLE tb_battery_info (
    material_id INTEGER PRIMARY KEY REFERENCES tb_material(material_id) ON DELETE CASCADE,
    lifespan_cycles INTEGER NOT NULL,
    current_cycles INTEGER NOT NULL DEFAULT 0
);

INSERT INTO tb_material_category (category_name) VALUES ('电池');

INSERT INTO tb_material_usage_record (material_id, user_id, borrow_time, return_time, usage_project) VALUES
-- 机器人对抗赛 (RoboMaster风格) - 20条记录
(1, 2, '2024-03-01 09:00:00', '2024-03-15 17:00:00', '2024机器人对抗赛-步兵机器人视觉开发'),
(6, 4, '2024-03-01 09:05:00', '2024-03-15 17:05:00', '2024机器人对抗赛-步兵机器人底盘控制'),
(8, 4, '2024-03-02 10:00:00', '2024-03-16 18:00:00', '2024机器人对抗赛-云台控制'),
(11, 2, '2024-03-02 10:05:00', '2024-03-16 18:05:00', '2024机器人对抗赛-机器人大脑'),
(15, 5, '2024-03-03 11:00:00', '2024-03-17 19:00:00', '2024机器人对抗赛-哨兵机器人测距'),
(18, 1, '2024-03-03 11:05:00', '2024-03-17 19:05:00', '2024机器人对抗赛-发射机构'),
(1, 5, '2024-04-01 09:00:00', '2024-04-15 17:00:00', '机器人对抗赛-视觉自瞄调试'),
(6, 3, '2024-04-01 09:05:00', '2024-04-15 17:05:00', '机器人对抗赛-底盘驱动调试'),
(8, 3, '2024-04-02 10:00:00', '2024-04-16 18:00:00', '机器人对抗赛-电机性能测试'),
(11, 2, '2024-04-02 10:05:00', '2024-04-16 18:05:00', '机器人对抗赛-AI识别模块'),
(13, 4, '2024-04-03 11:00:00', '2024-04-17 19:00:00', '机器人对抗赛-近距离避障'),
(14, 4, '2024-04-03 11:05:00', '2024-04-17 19:05:00', '机器人对抗赛-红外检测'),
(16, 1, '2024-04-04 14:00:00', '2024-04-18 20:00:00', '机器人对抗赛-搭建机器人框架'),
(18, 1, '2024-04-04 14:05:00', '2024-04-18 20:05:00', '机器人对抗赛-摩擦轮'),
(9, 3, '2024-05-01 10:00:00', '2024-05-15 18:00:00', '机器人对抗赛-云台舵机更换'),
(7, 4, '2024-05-01 10:05:00', '2024-05-15 18:05:00', '机器人对抗赛-备用控制器'),
(2, 5, '2024-05-02 11:00:00', '2024-05-16 19:00:00', '机器人对抗赛-广角视野测试'),
(4, 5, '2024-05-02 11:05:00', '2024-05-16 19:05:00', '机器人对抗赛-高速图像传输'),
(10, 3, '2024-05-03 14:00:00', '2024-05-17 20:00:00', '机器人对抗赛-工程机器人PLC控制'),
(20, 1, '2024-05-03 14:05:00', '2024-05-17 20:05:00', '机器人对抗赛-工程机器人机械臂'),

-- 机器人寻迹避障项目 - 20条记录
(7, 4, '2024-01-10 09:00:00', '2024-01-24 17:00:00', '智能车寻迹项目-主控板'),
(13, 4, '2024-01-10 09:05:00', '2024-01-24 17:05:00', '智能车寻迹项目-超声波避障'),
(14, 4, '2024-01-11 10:00:00', '2024-01-25 18:00:00', '智能车寻迹项目-红外传感器循迹'),
(18, 1, '2024-01-11 10:05:00', '2024-01-25 18:05:00', '智能车寻迹项目-车轮电机'),
(6, 3, '2024-02-10 09:00:00', '2024-02-24 17:00:00', '机器人避障算法研究-STM32平台'),
(13, 3, '2024-02-10 09:05:00', '2024-02-24 17:05:00', '机器人避障算法研究-距离感知'),
(15, 3, '2024-02-11 10:00:00', '2024-02-25 18:00:00', '机器人避障算法研究-激光雷达辅助'),
(16, 1, '2024-02-11 10:05:00', '2024-02-25 18:05:00', '机器人避障算法研究-测试平台搭建'),
(7, 2, '2024-03-10 09:00:00', '2024-03-24 17:00:00', 'Arduino小车循迹-基础教学'),
(14, 2, '2024-03-10 09:05:00', '2024-03-24 17:05:00', 'Arduino小车循迹-循迹模块'),
(9, 2, '2024-03-11 10:00:00', '2024-03-25 18:00:00', 'Arduino小车循迹-转向舵机'),
(18, 2, '2024-03-11 10:05:00', '2024-03-25 18:05:00', 'Arduino小车循迹-驱动电机'),
(6, 5, '2024-04-10 09:00:00', '2024-04-24 17:00:00', '毕业设计-自主导航小车-主控'),
(13, 5, '2024-04-10 09:05:00', '2024-04-24 17:05:00', '毕业设计-自主导航小车-避障'),
(15, 5, '2024-04-11 10:00:00', '2024-04-25 18:00:00', '毕业设计-自主导航小车-测距'),
(11, 5, '2024-04-11 10:05:00', '2024-04-25 18:05:00', '毕业设计-自主导航小车-路径规划'),
(18, 1, '2024-04-12 11:00:00', '2024-04-26 19:00:00', '毕业设计-自主导航小车-动力系统'),
(16, 1, '2024-04-12 11:05:00', '2024-04-26 19:05:00', '毕业设计-自主导航小车-车体结构'),
(2, 5, '2024-05-10 09:00:00', '2024-05-24 17:00:00', '视觉循迹项目-摄像头选型'),
(3, 5, '2024-05-10 09:05:00', '2024-05-24 17:05:00', '视觉循迹项目-补光灯'),

-- 机器视觉开发项目 - 20条记录
(1, 2, '2023-11-01 10:00:00', '2023-11-15 18:00:00', '工业零件缺陷检测项目-相机'),
(3, 2, '2023-11-01 10:05:00', '2023-11-15 18:05:00', '工业零件缺陷检测项目-光源'),
(4, 2, '2023-11-02 11:00:00', '2023-11-16 19:00:00', '工业零件缺陷检测项目-采集卡'),
(5, 2, '2023-11-02 11:05:00', '2023-11-16 19:05:00', '工业零件缺陷检测项目-标定'),
(1, 5, '2023-12-01 10:00:00', '2023-12-15 18:00:00', '物体识别与跟踪算法研究-相机'),
(2, 5, '2023-12-01 10:05:00', '2023-12-15 18:05:00', '物体识别与跟踪算法研究-镜头'),
(11, 5, '2023-12-02 11:00:00', '2023-12-16 19:00:00', '物体识别与跟踪算法研究-计算平台'),
(20, 1, '2023-12-02 11:05:00', '2023-12-16 19:05:00', '物体识别与跟踪算法研究-测试机械臂'),
(1, 2, '2024-01-15 14:00:00', '2024-01-29 20:00:00', '二维码读取项目-相机测试'),
(3, 2, '2024-01-15 14:05:00', '2024-01-29 20:05:00', '二维码读取项目-光源测试'),
(1, 5, '2024-02-15 14:00:00', '2024-02-29 20:00:00', '人脸识别系统开发-摄像头'),
(11, 5, '2024-02-15 14:05:00', '2024-02-29 20:05:00', '人脸识别系统开发-处理单元'),
(2, 2, '2024-03-20 10:00:00', '2024-04-03 18:00:00', '全景图像拼接-鱼眼镜头'),
(4, 2, '2024-03-20 10:05:00', '2024-04-03 18:05:00', '全景图像拼接-图像采集'),
(5, 5, '2024-04-20 10:00:00', '2024-05-04 18:00:00', '相机标定练习'),
(1, 5, '2024-04-20 10:05:00', '2024-05-04 18:05:00', '相机标定练习-相机'),
(3, 5, '2024-05-20 10:00:00', '2024-06-03 18:00:00', '视觉光源特性研究'),
(11, 2, '2024-05-20 10:05:00', '2024-06-03 18:05:00', '深度学习模型训练-GPU平台'),
(4, 2, '2024-06-01 15:00:00', '2024-06-15 21:00:00', '高速相机数据采集'),
(10, 3, '2024-06-01 15:05:00', '2024-06-15 21:05:00', '自动化产线视觉集成'),

-- 嵌入式与硬件开发 - 20条记录
(6, 4, '2023-10-10 09:00:00', '2023-10-24 17:00:00', 'STM32驱动开发'),
(7, 4, '2023-10-10 09:05:00', '2023-10-24 17:05:00', 'Arduino原型验证'),
(8, 4, '2023-10-11 10:00:00', '2023-10-25 18:00:00', '电机驱动测试'),
(12, 4, '2023-10-11 10:05:00', '2023-10-25 18:05:00', '无线通信模块调试'),
(11, 2, '2023-11-10 09:00:00', '2023-11-24 17:00:00', '树莓派物联网网关开发'),
(13, 2, '2023-11-10 09:05:00', '2023-11-24 17:05:00', '物联网传感器接入'),
(15, 2, '2023-11-11 10:00:00', '2023-11-25 18:00:00', '物联网节点测距'),
(6, 3, '2023-12-10 09:00:00', '2023-12-24 17:00:00', '嵌入式系统课程设计'),
(9, 3, '2023-12-10 09:05:00', '2023-12-24 17:05:00', '嵌入式系统课程设计-舵机'),
(10, 3, '2024-01-10 14:00:00', '2024-01-24 20:00:00', 'PLC项目-控制柜接线'),
(12, 4, '2024-01-10 14:05:00', '2024-01-24 20:05:00', '远程遥控小车-无线模块'),
(11, 5, '2024-02-20 09:00:00', '2024-03-05 17:00:00', '便携式服务器搭建'),
(6, 4, '2024-02-20 09:05:00', '2024-03-05 17:05:00', 'FreeRTOS系统移植'),
(7, 3, '2024-03-20 09:00:00', '2024-04-03 17:00:00', '电子设计入门'),
(8, 3, '2024-03-20 09:05:00', '2024-04-03 17:05:00', '电子设计入门'),
(14, 2, '2024-04-20 09:00:00', '2024-05-04 17:00:00', '传感器网络实验'),
(15, 2, '2024-04-20 09:05:00', '2024-05-04 17:05:00', '传感器网络实验'),
(10, 4, '2024-05-20 14:00:00', '2024-06-03 20:00:00', '工业自动化控制实验'),
(11, 5, '2024-06-05 09:00:00', '2024-06-19 17:00:00', '边缘计算设备测试'),
(12, 4, '2024-06-05 09:05:00', '2024-06-19 17:05:00', '长距离无线通信测试'),

-- 机械设计与制造 - 20条记录
(16, 1, '2024-01-05 10:00:00', '2024-01-19 18:00:00', '机器人底盘结构设计'),
(17, 1, '2024-01-05 10:05:00', '2024-01-19 18:05:00', '机器人舵机安装'),
(18, 1, '2024-01-06 11:00:00', '2024-01-20 19:00:00', '减速电机选型测试'),
(19, 1, '2024-01-06 11:05:00', '2024-01-20 19:05:00', '电机联轴器适配'),
(20, 1, '2024-02-05 10:00:00', '2024-02-19 18:00:00', '机械臂搭建与调试'),
(9, 1, '2024-02-05 10:05:00', '2024-02-19 18:05:00', '机械臂爪子舵机'),
(16, 1, '2024-03-05 10:00:00', '2024-03-19 18:00:00', '3D打印机框架搭建'),
(18, 1, '2024-03-05 10:05:00', '2024-03-19 18:05:00', '3D打印机Z轴电机'),
(19, 1, '2024-03-06 11:00:00', '2024-03-20 19:00:00', '3D打印机同步带联轴器'),
(17, 1, '2024-04-05 10:00:00', '2024-04-19 18:00:00', '机械结构件组装'),
(20, 1, '2024-04-05 10:05:00', '2024-04-19 18:05:00', '机械臂重复定位精度测试'),
(16, 1, '2024-05-05 10:00:00', '2024-05-19 18:00:00', '实验平台搭建'),
(17, 1, '2024-05-05 10:05:00', '2024-05-19 18:05:00', '实验平台舵机支架'),
(18, 1, '2024-05-06 11:00:00', '2024-05-20 19:00:00', '实验平台动力部分'),
(19, 1, '2024-05-06 11:05:00', '2024-05-20 19:05:00', '实验平台传动轴连接'),
(20, 1, '2024-06-05 14:00:00', '2024-06-19 20:00:00', '毕业设计-六足机器人'),
(9, 1, '2024-06-05 14:05:00', '2024-06-19 20:05:00', '毕业设计-六足机器人-腿部舵机'),
(18, 1, '2024-06-06 15:00:00', '2024-06-20 21:00:00', '毕业设计-六足机器人-核心电机'),
(16, 1, '2024-06-06 15:05:00', '2024-06-20 21:05:00', '毕业设计-六足机器人-机身'),
(17, 1, '2024-06-07 16:00:00', '2024-06-21 22:00:00', '毕业设计-六足机器人-腿部支架');